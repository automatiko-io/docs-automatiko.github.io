<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service invocation :: Automatiko</title>
    <link rel="canonical" href="https://docs.automatiko.io/main/0.9.0/components/service-invocation.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R2G3H6TJRK"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-R2G3H6TJRK')</script>
    <link rel="icon" href="../../../_/img/automatiko-logo-circle.png" type="image/png">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.automatiko.io"><img src="../../../_/img/automatiko-logo-circle.png" width="52px"/>Automatiko</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/automatiko-io">Souce code</a>
            <a class="navbar-item" href="https://github.com/automatiko-io/automatiko-engine/issues">Issues</a>
            <a class="navbar-item" href="https://github.com/automatiko-io/automatiko-engine/blob/master/CONTRIBUTING.md">Contribution</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="main" data-version="0.9.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../about.html">Automatiko Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../about.html">About</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../concepts.html">Concepts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../use-cases.html">Use cases</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../examples.html">Examples</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../best-practice.html">Best practice</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../service-interfaces.html">Service interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Components</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="messaging.html">Messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="persistence.html">Persistence</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="service-invocation.html">Service invocation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="errors.html">Error handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="management.html">Process management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="event-publishers.html">Event publishers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="user-tasks.html">User tasks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="async-execution.html">Async Execution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="files.html">Handling files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../configuration.html">Configuration reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Services</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../services/archive.html">Archive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../services/email.html">Send Email</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../services/receive-email.html">Receive Email</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Automatiko Documentation</span>
    <span class="version">0.9.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Automatiko Documentation</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../about.html">0.9.0</a>
        </li>
        <li class="version">
          <a href="../../0.8.0/about.html">0.8.0</a>
        </li>
        <li class="version">
          <a href="../../0.7.0/about.html">0.7.0</a>
        </li>
        <li class="version">
          <a href="../../0.6.0/about.html">0.6.0</a>
        </li>
        <li class="version">
          <a href="../../0.5.0/about.html">0.5.0</a>
        </li>
        <li class="version">
          <a href="../../0.4.0/about.html">0.4.0</a>
        </li>
        <li class="version">
          <a href="../../0.3.0/about.html">0.3.0</a>
        </li>
        <li class="version">
          <a href="../../0.2.0/about.html">0.2.0</a>
        </li>
        <li class="version">
          <a href="../../0.1.0/about.html">0.1.0</a>
        </li>
        <li class="version">
          <a href="../../0.0.0/about.html">0.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../about.html">Automatiko Documentation</a></li>
    <li>Components</li>
    <li><a href="service-invocation.html">Service invocation</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.9.0</button>
  <div class="version-menu">
    <a class="version is-current" href="service-invocation.html">0.9.0</a>
    <a class="version" href="../../0.8.0/components/service-invocation.html">0.8.0</a>
    <a class="version is-missing" href="../../0.7.0/about.html">0.7.0</a>
    <a class="version is-missing" href="../../0.6.0/about.html">0.6.0</a>
    <a class="version is-missing" href="../../0.5.0/about.html">0.5.0</a>
    <a class="version is-missing" href="../../0.4.0/about.html">0.4.0</a>
    <a class="version is-missing" href="../../0.3.0/about.html">0.3.0</a>
    <a class="version is-missing" href="../../0.2.0/about.html">0.2.0</a>
    <a class="version is-missing" href="../../0.1.0/about.html">0.1.0</a>
    <a class="version" href="../../0.0.0/components/service-invocation.html">0.0.0</a>
  </div>
</div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Service invocation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the most common tasks in workflows is <strong>service task</strong>. This task is responsible for invoking an operation.
There might be various types of operations such as</p>
</div>
<div class="ulist">
<ul>
<li>
<p>java method in one of the service classes of the project itself</p>
</li>
<li>
<p>ReST call to remote service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These operations are configured as a service tasks and invoked by the workflow engine.</p>
</div>
<div class="paragraph">
<p>Service tasks can also be equipped with error handling by the use of boundary events,
<a href="errors.html#_defining_errors" class="page">see details here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoking_local_service"><a class="anchor" href="#_invoking_local_service"></a>Invoking local service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Services can be implemented as part of the project itself. That means they reside in the same code base and usually
are represented as CDI bean that enables additional dependent services and/or classes to be automatically injected.</p>
</div>
<div class="paragraph">
<p>As an example, one can fetch information from the data base and thus the service responsible for connecting to a data base
will need to get hold of data source to be able to obtain connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonDataLoader {

	@Inject
	DataSource dataSource;


	public List&lt;Person&gt; load() {
		// implementation of the loading logic

	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the workflow side, such service is declared as interface where there are following information required</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interface name - that will be used to reference it from service tasks</p>
</li>
<li>
<p>Interface implementation - fully classified class name</p>
</li>
<li>
<p>Operations - list of operation names that match the method names of the service class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are declared on the workflow level, via properties panel.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/local-service-declaration.png" alt="local service declaration"></span></p>
</div>
<div class="paragraph">
<p>Once interfaces and their operations are defined, service tasks can reference them.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/local-service-def.png" alt="local service def"></span></p>
</div>
<div class="paragraph">
<p>Lastly service operations can require inputs and might produce outputs. These
can be mapped to and from workflow instance variables via <code>IO parameters</code> of
the service task</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/local-service-io.png" alt="local service io"></span></p>
</div>
<div class="paragraph">
<p>Where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Input Data Mapping corresponds to operation arguments</p>
</li>
<li>
<p>Output Data Mapping corresponds to returned value from the operation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is all that it takes to invoke a local service operation from within workflow.</p>
</div>
<div class="sect2">
<h3 id="_asynchronous_service_invocation"><a class="anchor" href="#_asynchronous_service_invocation"></a>Asynchronous service invocation</h3>
<div class="paragraph">
<p>Sometimes there might be a service call that might take more time and thus shall be invoked
asynchronously. Or it simply blocks on IO and thus can be inefficient to block threads and thus
become a bottleneck in the service as a whole.</p>
</div>
<div class="paragraph">
<p>To address that, service implementation can be made reactive and thus follow the continuation pattern.
In other words this will release the thread whenever it is about to block and schedule IO operation to
continue as soon as it produces results.</p>
</div>
<div class="paragraph">
<p>The implementation is based on <a href="https://smallrye.io/smallrye-mutiny/index.html">SmallRye Mutiny</a> that
implements efficient layer for reactive programming.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonDataLoader {

	@Inject
	DataSource dataSource;


	public Uni&lt;List&lt;Person&gt;&gt; load() {
		// implementation of the loading logic

	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be noted, the only thing here is the return type that returns <code>Uni</code> (a reactive type of Mutiny)
and based on that information, workflow engine will apply the continuation pattern freeing the thread and the workflow instance
from being blocked.</p>
</div>
<div class="paragraph">
<p>There is no need to make any modifications on the workflow definition to make use of asynchronous invocation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoking_rest_service"><a class="anchor" href="#_invoking_rest_service"></a>Invoking REST service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As opposed to local services, workflows in many cases need to interact with outside world. Especially
common when implementing orchestration based service where coordination of various external systems is a key.</p>
</div>
<div class="paragraph">
<p>To make this possible, service tasks allow to invoke ReST services based on OpenAPI service description.</p>
</div>
<div class="paragraph">
<p>Main part required for this use case is the OpenAPI service description that is either locally
(inside the project&#8217;s resource folder <code>src/main/resources</code>) or remotely (accessible over the http(s) protocol).</p>
</div>
<div class="paragraph">
<p>On the workflow side, such service is declared as interface where there are following information required</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interface name - that will be used to reference it from service tasks</p>
</li>
<li>
<p>Interface implementation - location of the OpenAPI service description (<code>/api/swagger-petstore.json</code> or
<code><a href="https://petstore.swagger.io/v2/swagger.json" class="bare">https://petstore.swagger.io/v2/swagger.json</a></code>)</p>
</li>
<li>
<p>Operations - list of operations that match the <code>operationId</code> from OpenAPI service description</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are declared on the workflow level, via properties panel.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/rest-service-declaration.png" alt="rest service declaration"></span></p>
</div>
<div class="paragraph">
<p>Once interfaces and their operations are defined, service tasks can reference them.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/rest-service-def.png" alt="rest service def"></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that ReST service when being referenced needs to select the <code>webservice</code> as implementation
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lastly service operations can require inputs and might produce outputs. These
can be mapped to and from workflow instance variables via <code>IO parameters</code> of
the service task</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/local-service-io.png" alt="local service io"></span></p>
</div>
<div class="paragraph">
<p>Where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Input Data Mapping corresponds to operation arguments</p>
</li>
<li>
<p>Output Data Mapping corresponds to returned value from the operation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is all that it takes to invoke a ReST service operation from within workflow.</p>
</div>
<div class="sect2">
<h3 id="_asynchronous_service_invocation_2"><a class="anchor" href="#_asynchronous_service_invocation_2"></a>Asynchronous service invocation</h3>
<div class="paragraph">
<p>Similar to local service calls, ReST service invocation can also be made asynchronous. Here it is
even more important as going to remote ReST service over the network is certainly a blocking operation
with no clear information how fast or how slow it can be.</p>
</div>
<div class="paragraph">
<p>To make the ReST operation asynchronous, workflow definition must declare that on the interface operation level
as additional parameter on top of the operation name e.g. <code>createUser?mode=async</code></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/rest-async-service-declaration.png" alt="rest async service declaration"></span></p>
</div>
<div class="paragraph">
<p>And this is the only required change to make the service run in asynchronous manner.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fault_tolerance"><a class="anchor" href="#_fault_tolerance"></a>Fault tolerance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One important aspect of service invocation is to be able to deal with failures. Failures are to be expected so being able
to deal with them in various ways is important, even more important when working with workflows that allow to
easily take advantage of various features of fault tolerance.</p>
</div>
<div class="paragraph">
<p>One obvious way of dealing with failures is error handling that is already covered
<a href="errors.html#_defining_errors" class="page">here</a>. Error handling allows us to cover a retry or taking another
path of the workflow in case of a failure. But error handling is not the only way to become more fault
tolerant on service invocation. Another approaches are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>circuit breakers</p>
</li>
<li>
<p>timeouts</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_circuit_breakers"><a class="anchor" href="#_circuit_breakers"></a>Circuit breakers</h3>
<div class="paragraph">
<p>Circuit breakers allow to guard the service from being constantly invoked in case it is already failing.
This is mainly to reduce the stress put on the service as it might be as simple as service is overloaded.
Circuit breaker can be opened based on defined threshold to avoid service from being invoked at all if it is already
 known to be the failing. That in turn will make the worklfow instance to be in error state but reduce
 calls to the actual service.</p>
</div>
<div class="paragraph">
<p>In addition to that, workflows actually track these errors and observes state of the circuit breakers to be able
to easily resume work on failed instances as soon as the circuit is closed again, meaning that service is now
working correctly and can process incoming requests.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When circuit is closed (service is now operational) all failing instance of that type will be automatically resumed.
Resume is done in sequence and reacts in case of repeated circuit being opened and directly stop resume procedure.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This capability is defined on each service task of the workflow definition. The reason why it is done on the
service task and not the interface operation itself is to have better control over how service is invoked
from within the workflow.</p>
</div>
<div class="paragraph">
<p>Following is a list of custom attributes that configure circuit breaker on service task</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Circuit breaker configuration parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requestThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of consecutive requests in a rolling window</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">failureRatio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ratio of failures within the rolling window that will trip the circuit to open</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The delay after which an open circuit will transitions to half-open state (when the service will be probed)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Circuit breaker and error handling - all errors defined for given service task (boundary event and event subprocesses)
will by pass circuit breaker as they are considered with higher priority as they were defined in the workflow.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_timeout"><a class="anchor" href="#_timeout"></a>Timeout</h3>
<div class="paragraph">
<p>Timeout allows to guard the workflow instance from waiting too long on service call to return. If set then the service
invocation will be interrupted and exception will be thrown with error code set to <code>408</code>. Then error handling can be applied on
it in the same way as for any other errors.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Timeout configuration parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout (in milliseconds) before service invocation is interrupted and exception is thrown (error code 408)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 (meaning won\t be used)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_use_it"><a class="anchor" href="#_use_it"></a>Use it</h3>
<div class="paragraph">
<p>First of all, a dependency to <code>automatiko-fault-tolerance-addon</code> needs to be added to the project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.automatiko.addons&lt;/groupId&gt;
  &lt;artifactId&gt;automatiko-fault-tolerance-addon&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then each service task can have timeout and circuit breaker custom attributes set based on the needs.
Lastly, in case fault tolerance features are not needed on given task following custom attribute can be
specified to disable it.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Fault tolerance configuration parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">faultToleranceDisabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables fault tolerance on given service task</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p class="text-center">© 2020 Automatiko. All rights reserved.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
